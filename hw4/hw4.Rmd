---
title: "Biostat M280 Homework 4"
subtitle: Due Mar 16 @ 11:59PM
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Our Apache Yarn cluster hosts the [flights](http://stat-computing.org/dataexpo/2009/the-data.html) data representing 123 million flights over 22 years. Read the [lecture notes](http://hua-zhou.github.io/teaching/biostatm280-2018winter/slides/12-sparklyr/sparklyr-flights.html) on how to access the Yarn cluster. Connect to the database using `sparklyr` and answer following questions. You can base your answers on a specific year or the whole data set.

```{r}
spark_disconnect_all()

library(tidyverse)
library(sparklyr)
library(ggplot2)

library(ggmap)
library(maps)
library(mapdata)

library(lubridate)
library(ggrepel)
library(modelr)
library(olsrr)

Sys.setenv(SPARK_HOME="/usr/lib/spark")
config <- spark_config()
sc <- spark_connect(master = "yarn-client", config = config)
sc

flights_tbl <- tbl(sc, 'flights')
head(flights_tbl)

airlines_tbl <- tbl(sc, 'airlines')
head(airlines_tbl)

airports_tbl <- tbl(sc, 'airports')
head(airports_tbl)

```


1. Map the top 10 busiest airports. Size of dots should reflect the number of flights through that destination.  
Hint: You may find this tutorial on [Making Maps in R](http://eriqande.github.io/rep-res-web/lectures/making-maps-with-R.html) helpful.

  

```{r}
#10 busiest airports in year 2002

#origin airpots
f_origin <- flights_tbl %>%
  filter(year == 2002 & !is.na(origin)) %>%
  group_by(origin) %>%
  tally() %>% 
  arrange(desc(n)) %>%
  collect() %>% 
  head(10)

f_origin

colnames(f_origin) <- c("origin", "outgoing")

#destination airports
  f_dest <- flights_tbl %>%
    filter(year == 2002 & !is.na(dest)) %>%
    group_by(dest) %>%
    tally() %>% 
    arrange(desc(n)) %>%
    collect() %>% 
    head(10)

  
  f_dest

colnames(f_dest) <- c("dest", "incoming")

# combined table (top origin and dest airports)
combined <- f_origin %>%
  left_join(f_dest, by = c("origin" = "dest")) %>%
  transmute(airport = origin,
            n = outgoing + incoming) %>%
  head(10)

combined 

#airport longitude and latitude
  location <- combined %>%
    left_join(airports_tbl, by = c("airport" = "faa"), copy = TRUE) %>%
    select(airport, n, lon, lat) %>%
    mutate(
      lon = as.double(lon),
      lat = as.double(lat)) %>%
    collect()
  

write_rds(location, "location.rds")
```




  **Table and plots based off of flights in the year 2002.**
  
  First, the top 10 origin airports (airports that had the most outgoing flights) were found. Then, the top 10 destination airports (ones that had the most incoming flights) were found. Both results were combined into one table.

  From this table, the top 10 busiest airports in the year 2002 are ORD, DFW, ATL, LAX, PHX, MSP, DTW, STL, LAS and DEN. Total n was calculated by adding the number of flights in these airports as the origin airport as well as as the destination airport.
  


```{r}
#plot the 10 busiest airports on map

usa <- map_data("usa")



us_map <- ggplot(data = states) + 
  geom_polygon(data = usa, aes(x = long, y = lat, group = group), fill = NA, color = "blue") + 
  coord_fixed(1.3) +
  guides(fill=FALSE) 

map1 <- us_map + 
  geom_point(data = location, 
             aes(x = lon, y = lat, size = n/sum(n)), 
             color = "red")

map1 <- map1+
  geom_label_repel(data = location, 
                   aes(x = lon, y = lat, label = airport, size = n/sum(n),
                       fill = factor(airport)), min.segment.length = 0,
                   size = 3.5) +
  ggtitle("Top 10 Busiest Airports for Year 2002")
map1





```


  This map represents the top 10 busiest airports plotted on the U.S. map (size of dot is proportional/scaled to how many flights this airport receives).



0. Map the top 10 busiest direct routes. Size of lines should reflect the number of flights through that route.

```{r}

flights_tbl %>% 
  filter(year == 2002) %>% 
  group_by(origin, dest) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  head(30) %>% 
  collect()


```
  
  
  From this table, the top 10 busiest routes for the year 2002 are:
  
  - LAX to LAS
  - MSP to ORD
  - BOS to LGA
  - LAS to PHX
  - LAX to PHX
  - LGA to DCA
  - ORD to LGA
  - EWR to ORD
  - HOU to DAL
  - ORD to PHL
  
  Each row in this table represents total number of flights of one specific route (i.e. one specific origin airport to destination airport). Table is arranged in descending order. 

```{r}
#Make a new dataframe of top 10 busiest routes
airport1 <- c("LAX", "LAS", #12,733 + 12,256 = 24,989
              "MSP", "ORD", #12,007 + 11,907 = 23,914
              "BOS", "LGA", #11,539 + 11,537 = 23,076
              "LAS", "PHX", #11,143 + 11,091 = 22,234
              "LAX", "PHX", #11,066 + 11,027 = 22,093
              "LGA", "DCA", #10,955 + 10,948 = 21,903
              "ORD", "LGA", #10,639 + 10,566 = 21,205
              "EWR", "ORD", #10,278 + 10,126 = 20,404
              "HOU", "DAL", #10,612 + 9,507 = 20,119
              "ORD", "PHL") #10,109 + 9,954 = 20,063
              
n1 <- c(24989, 23914, 23076, 22234, 22093, 21903, 21205, 20404, 20119, 20063)
sum(n1)

df1 <- data.frame(airport1, n1)
df1
```
  
  This data frame represents the top 10 busiest routes. A route is defined as having one specific airport as the origin and another airport as the destination. Total n for routes was calculated as adding one specific route + the same route with the same airports, but with the origin and destination airports flipped. For example, the busiest route is LAX to LAS. The total n for this route was calculated as total number of flights from LAX to LAS + total number of flights from LAS to LAX.
  
  
```{r}
sum(n1)
labs1 <- data.frame(
  long1 <- c(-118.41, -115.15),
  lat1 <- c(33.94, 36.08),
  names1 <- c("LAX", "LAS"),
  size1 <- 20*24989/sum(n1),
  stringsAsFactors = FALSE)
#24,989/22,000 = 0.11 

labs2 <- data.frame(
  long2 <- c(-80.192, -87.84),
  lat2 <- c(25.762, 41.98),
  names2 <- c("MSP", "ORD"),
  size2 <- 18*23914/sum(n1),
  stringsAsFactors = FALSE)

#23,914/22,000 = 0.1087

labs3 <- data.frame(
  long3 <- c(-71.02, -73.87),
  lat3 <- c(42.37, 40.78),
  names3 <- c("BOS", "LGA"),
  size3 <- 14*23076/sum(n1),
  stringsAsFactors = FALSE)

#23,076/22,000 = 0.104

labs4 <- data.frame(
  long4 <- c(-115.15, -112.07),
  lat4 <- c(36.08, 33.45),
  names4 <- c("LAS", "PHX"),
  size4 <- 10*22234/sum(n1),
  stringsAsFactors = FALSE)

#22,234/22,000 = 0.101

labs5 <- data.frame(
  long5 <- c(-118.41, -112.07),
  lat5 <- c(33.94, 33.45),
  names5 <- c("BOS", "LGA"),
  size5 <- 10*22093/sum(n1),
  stringsAsFactors = FALSE)

#22,093/22,000 = 0.0996

labs6 <- data.frame(
  long6 <- c(-73.87, -77.04),
  lat6 <- c(40.78, 38.85),
  names6 <- c("LGA", "DCA"),
  size6 <- 10*21903/sum(n1),
  stringsAsFactors = FALSE)

#21,093/22,000 = 0.0995

labs7 <- data.frame(
  long7 <- c(-87.84, -73.87),
  lat7 <- c(41.98, 40.78),
  names7 <- c("ORD", "LGA"),
  size7 <- 10*21205/sum(n1),
  stringsAsFactors = FALSE)

#21,205/22,000 = 0.0963

labs8 <- data.frame(
  long8 <- c(-74.17, -87.84),
  lat8 <- c(40.69, 41.98),
  names8 <- c("EWR", "ORD"),
  size8 <- 10*20404/sum(n1),
  stringsAsFactors = FALSE)

#20,404/22,000 = 0.0927


labs9 <- data.frame(
  long9 <- c(-95.37, -96.85),
  lat9 <- c(29.76, 32.85),
  names9 <- c("HOU", "DAL"),
  size9 <- 10*20119/sum(n1),
  stringsAsFactors = FALSE)

#20,119/22,000 = 0.0915


labs10 <- data.frame(
  long10 <- c(-87.84, -75.24),
  lat10 <- c(41.98, 39.87),
  names10 <- c("ORD", "PHL"),
  size10 <- 10*20063/sum(n1),
  stringsAsFactors = FALSE)

#20,063/22,000 = 0.0912


 gg1 + 
   geom_line(data = labs1, aes(x = long1, y = lat1), size = size1, color = "blue") + y
   geom_line(data = labs2, aes(x = long2, y = lat2), size = size2, color = "black") + y
   geom_line(data = labs3, aes(x = long3, y = lat3), size = size3, color = "gray") + y
   geom_line(data = labs4, aes(x = long4, y = lat4), size = size4, color = "orange") +
   geom_line(data = labs5, aes(x = long5, y = lat5), size = size5, color = "purple") + 
   geom_line(data = labs6, aes(x = long6, y = lat6), size = size6, color = "green") +
   geom_line(data = labs7, aes(x = long7, y = lat7), size = size7, color = "red") + y
   geom_line(data = labs8, aes(x = long8, y = lat8), size = size8, color = "yellow") +
   geom_line(data = labs9, aes(x = long9, y = lat9), size = size9, color = "white") + y
   geom_line(data = labs10, aes(x = long10, y = lat10), size = size10, color = "brown")

```

  It is difficult to distinguish the different sizes of the lines because the total number of flights in each route are close in number (range from 20,000 to 25,000) out of a total of 220,000 flights. So, the proportion of the top 10 busiest routes range from 9% to 11%. Size was scaled so that for every .2% drop, scaling factor was decreased by 2 to try to help better visualize the differences in size of lines.
  
  Also, note that two of the busiest routes include ORD to LGA and ORD to EWR. ORD is an airport in Chicago, LGA is an airport in Queens, New York and EWR is an airport in New Jersey. The routes for ORD to LGA and ORD to EWR overlap and are slightly difficult to distinguish. The red line (ORD to LGA) overlaps heavily with the yellow line (ORD to EWR).
   
   
0. LAX:
  
    <p align="center">
    ![](./lax-by-day-98-08.png)
    </p>

    (a). Reproduce above plot. Visualize and explain some prominent features you observe. For example, what happened at points 1-5?

```{r}
  lax_flights <- flights_tbl %>%
    filter(origin == "LAX" | dest == "LAX" & 
             !is.na(year) & !is.na(month) & !is.na(dayofmonth)) %>%
    select(origin, year, month, dayofmonth) %>%
    collect()

write_rds(lax_flights, "lax_flights.rds")


  lax_flights <- lax %>%
    mutate(date = make_date(year, month, dayofmonth)) %>%
    filter(date >= ymd(19980101) & date <= ymd(20081231)) %>%
    collect() 

  lax_flights %>% 
    group_by(date) %>%
    count() %>%
    ggplot(aes(x = date, y = n)) +
    geom_line() +
    geom_label(aes(x = ymd(20010911), y = 1150, label = "1")) +
    geom_label(aes(x = ymd(20041127), y = 1000, label = "2")) +
    geom_label(aes(x = ymd(20040710), y = 1050, label = "3")) +
    geom_label(aes(x = ymd(20080103), y = 1230, label = "4")) +
    geom_label(aes(x = ymd(20010101), y = 1180, label = "5")) +
    ggtitle("LAX air traffic") 

```

  Some prominent features include the labelled points 1-5. 
  
  - The sudden drop in flights in label 1 seems to be around the time of 9/11, where the Twin Towers in NYC were hit by airplanes. Airport security became a lot stricter after this incident, which proably explains why there is a sudden drop in flights. It was not until around 2004 and 2005 that the number of flights increased back to pre-9/11 levels.
  - Label 2 and label 3 both show sudden, drastic drops in number of flights. This may be due to how in July 2005, employment had fallen 28%, which also affected employment for aircraft carriers. With less aircraft employees, aircraft carriers are inevitably going to have less outgoing flights. (Source: Bureau of Transportation Statistics. https://www.rita.dot.gov/bts/sites/rita.dot.gov.bts/files/publications/special_reports_and_issue_briefs/issue_briefs/number_13/html/entire.html)
  - In label 4, flights initially decreased around 2008 possibly because around this time, there were plans to renovate the Tom Bradley International section in order to accommodate the growing need and demand for international flights. According to the Bureau of Transportation Statistics, after May 2005, demand in the flight market shifted towards having more international flights. So, while LAX was renovating the Tom Bradley International section, flights from LAX initially decreased because of this huge construction project (as these parts of the airport had to be closed), then flights to and from LAX went back up soon after renovations were finished.
  - In label 5, there is random fluctuation in flights. This might be because in early 2001s (beginning around March 2001), there was an economic recession in the U.S. due to the dot-com bubble as well as the housing market crash. This may have caused LAX to have fewer flights, and right after the recession ended, there was economic growth in the U.S. so there were more flights from LAX. However, after the 9/11 attacks (shown in point 1), flights dropped drastically again.
  
  
  
    (b). Visualize and explain seasonal effects.
    
    
  
    (c). Visualize and explain weekly effects.
  
    (d). Map top 10 destinations from LAX. Size of dots should reflect the number of flights from LAX to that destination.
    
0. Build a predictive model for the arrival delay (`arrdelay`) of flights flying from LAX. Use the same filtering criteria as in the [lecture notes](http://hua-zhou.github.io/teaching/biostatm280-2018winter/slides/12-sparklyr/sparklyr-flights.html) to construct training and validation sets. You are allowed to use a maximum of 5 predictors. The prediction performance of your model on the validation data set will be an important factor for grading this question.


```{r}
#training data - for cross validation
#split data into 2. keep 80% of data as training and 20% as validation data. set seed=5555 for reproducibility.

  model_data <- flights_tbl %>%
    filter(!is.na(arrdelay) & !is.na(depdelay) & !is.na(distance)) %>%
    filter(depdelay > 15 & depdelay < 240) %>%
    filter(arrdelay > -60 & arrdelay < 360) %>%
    filter(year >= 2003 & year <= 2007) %>%
    left_join(airlines_tbl, by = c("uniquecarrier" = "code")) %>%
    mutate(gain = depdelay - arrdelay) %>%
    select(year, month, arrdelay, depdelay, distance, uniquecarrier, description, gain)

model_data



```
    
0. Visualize and explain any other information you want to explore.
  

