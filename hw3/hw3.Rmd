---
title: "Biostat M280 Homework 3"
subtitle: Due Mar 2 @ 11:59PM
output: html_document
---



## Q1 LA City Employee Payroll

The `/home/m280-data/la_payroll/LA_City_Employee_Payroll.csv` file on teaching server contains payroll information of LA City employees in years 2013-2017. It was downloaded from [LA City Controller's Office](https://controllerdata.lacity.org/Payroll/City-Employee-Payroll/pazn-qyym). Make a Shiny app to facilitate exploratory data analysis. 

1. For efficiency of the Shiny app, you should first pre-process, pare down, tidy, and save the data, e.g., as a compressed RDS file, to be used in the app.


<!-- ```{r} -->
<!-- library("tidyverse") -->
<!-- ``` -->

<!-- ```{r} -->

<!-- #Read in RDS file -->
<!-- la_payroll <- read_csv("/home/m280-data/la_payroll/LA_City_Employee_Payroll.csv") -->

<!-- saveRDS(la_payroll, "la_payroll.rds", compress = TRUE) -->
<!-- LApayroll <- readRDS("la_payroll.rds") -->


<!-- #Rename the names of the columns -->
<!-- names(LApayroll) <- str_replace_all(names(LApayroll), " ", "_") -->

<!-- data_la_payroll <-  -->
<!--   LApayroll %>%  -->
<!--   select(Row_ID, Base_Pay, Overtime_Pay, Total_Payments, `Other_Pay_(Payroll_Explorer)`, Department_Title, Job_Class_Title, Year)   -->


<!-- #remove dollar signs -->
<!-- data_la_payroll$Base_Pay <- as.numeric(gsub("\\$", "", data_la_payroll$Base_Pay)) -->
<!-- data_la_payroll$Total_Payments <- as.numeric(gsub("\\$", "", data_la_payroll$Total_Payments)) -->
<!-- data_la_payroll$Overtime_Pay <- as.numeric(gsub("\\$", "", data_la_payroll$Overtime_Pay)) -->
<!-- data_la_payroll$`Other_Pay_(Payroll_Explorer)` <- as.numeric(gsub("\\$", "", data_la_payroll$`Other_Pay_(Payroll_Explorer)`)) -->

<!-- ``` -->

0. **Total payroll by LA City**. Visualize the total LA City payroll of each year, with breakdown into base pay, overtime pay, and other pay.

0. **Who earned most?** Visualize the payroll information (total payment with breakdown into base pay, overtime pay, and other pay, Department, Job Title) of the top $n$ highest paid LA City employees in a specific year. User specifies $n$ (default 10) and year (default 2017).

0. **Which departments earn most?** Visualize the mean or median payroll, with breakdown into base pay, overtime pay, and other pay, of top $n$ earning departments. User specifies $n$ (default 5), year (default 2017), and method (mean or median, default median).

0. **Which departments cost most?** Visualize the total payroll, with breakdown into base pay, overtime pay, and other pay, of top $n$ expensive departments. User specifies $n$ (default 5) and year (default 2017).

0. Visualize any other information you are interested in.

0. Publish your Shiny app to <https://www.shinyapps.io> and share the link.

## Q2 LA City Parking War

The SQLite database `/home/m280-data/la_parking/LA_Parking_Citations.sqlite` on teaching server contains information about parking tickets in LA City. It was downloaded from [LA Open Data Portal](https://data.lacity.org/A-Well-Run-City/Parking-Citations/wjz9-h9np). Connect to the database and answer following questions using plots and summary statistics. In this exercise, you are **not** allowed to load whole data into memory. Use the _transform in database, plot in R_ strategy.


```{r}
library("DBI")
library("RSQLite")
library("dplyr")
```


```{r}

# if (Sys.info()[["sysname"]] == "Linux") {
#   db <- dbConnect(RSQLite::SQLite(),
#                   dbname = "/home/m280-data/la_parking/LA_Parking_Citations_Extra.sqlite")
# } else if (Sys.info()[["sysname"]] == "Darwin") {
#   db <- dbConnect(RSQLite::SQLite(),
#                   dbname = "./LA_Parking_Citations.sqlite")
# }


db <- dbConnect(RSQLite::SQLite(),
                  dbname = "/home/m280-data/la_parking/LA_Parking_Citations_Extra.sqlite")
dbListTables(db)


latix_sql <- dplyr::tbl(db, "latix")
 
# 
# new_db <- dbSendQuery(db, "Select Issue_Year, Issue_Month, Issue_Day, Issue_Hour, Issue_Minute, Make, Violation_Description FROM latix")
# 
# la_tix <- as.data.frame(new_db)
# 





#  db1 <- dbConnect(RSQLite::SQLite(),
#                    dbname = "/home/m280-data/la_parking/LA_Parking_Citations_Extra.sqlite")
# dbListTables(db1)

# 
# 
# new_db <- dbSendQuery(db1, "Select Issue_Year, Issue_Month, Issue_Day, Issue_Hour, Issue_Minute, Make, Violation_Description FROM latix")
# 
# 
# latix_sql1 <- dplyr::tbl(new_db, "latix")




```


1. How many tickets are in this data set? Which time period do these tickets span? Which years have most data?

How many tickets (how many rows)?

```{r}

latix_sql <- dplyr::tbl(db, "latix")

latix_sql %>% 
  tally()
# str(latix_sql)
# 
# count(latix_sql)

```

  *There are 4,044,488 tickets in this data set.*

**Which time period do these tickets span?**
```{r}
time_ticket <- latix_sql %>% 
  filter(!is.na(Issue_Year)) %>% 
  select(Issue_Year, Issue_Month, Issue_Day, Issue_Hour, Issue_Minute) %>% 
  arrange(Issue_Year, Issue_Month, Issue_Day, Issue_Hour, Issue_Minute) 

head(time_ticket, 1)

time_ticket1 <- latix_sql %>% 
  filter(!is.na(Issue_Year)) %>% 
  select(Issue_Year, Issue_Month, Issue_Day, Issue_Hour, Issue_Minute) %>% 
  arrange(desc(Issue_Year), desc(Issue_Month), desc(Issue_Day), desc(Issue_Hour), desc(Issue_Minute)) 

head(time_ticket1, 1)


# latix <- as.data.frame(latix_sql)
# 
# latix$Issue_DateTime <- anydate(latix$Issue_DateTime)
# 
# sorted_dates <- sort(latix$Issue_DateTime)
# head(sorted_dates)
# tail(sorted_dates)
# 
# latix_sql
# filter
# select
# arrange

```

*The time period spans from 4-27-2010 to 12-30-2017*



**Which years have most data?**
```{r}

tbl(db, "latix") %>% 
  filter(!is.na(Issue_Year)) %>% 
  group_by(Issue_Year) %>% 
  tally() %>% 
  collect() %>% 
  ggplot() +
  geom_col(aes(x = Issue_Year, y = n)) +
  scale_x_continuous(breaks = c(2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017)) 

                     
                     # 
                     # label = c("2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017"))

# 
#   filter(n == max(n))
# 
#  collect() %>%
#   ggplot() + 
#     geom_col(aes(x = Issue_WDay, y = n))
# 
# year


# year_visual <- tbl(db, "latix") %>% 
#   select(Issue_Year) %>% 
#   ggplot(aes(x)) +
#   geom_bar()
# 
# 

# years <- substr(latix$Issue_DateTime, 1, 4)
# 
# table(years)

```
*The year 2015 has the most data*



0. When (which hour, weekday, month day, and month) are you most likely to get a ticket and when are you least likely to get a ticket?

**Most likely to get a ticket**
```{r}
#Month
 tbl(db, "latix") %>% 
  filter(!is.na(Issue_Month)) %>% 
  group_by(Issue_Month) %>% 
  tally() %>% 
  collect() %>% 
  ggplot() +
  geom_col(aes(x = Issue_Month, y = n)) +
  scale_x_continuous(breaks = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12),
  label = c("Jan","Feb", "Mar", "Apr", "May", "June", "Jul", "Aug", "Sept", "Oct", "Nov", "Dec"))
  

#Hour
 tbl(db, "latix") %>%
   filter(!is.na(Issue_Hour)) %>% 
   group_by(Issue_Hour) %>% 
   tally() %>% 
   collect() %>% 
   ggplot() +
   geom_col(aes(x = Issue_Hour, y = n)) 
 
 #Weekday
 tbl(db, "latix") %>%
   filter(!is.na(Issue_Wday)) %>% 
   group_by(Issue_Wday) %>% 
   tally() %>% 
   collect() %>% 
   ggplot() +
   geom_col(aes(x = Issue_Wday, y = n)) +
   scale_x_continuous(breaks = c(1 ,2 ,3, 4, 5, 6, 7), label = c("Sun", "Mon", "Tues", "Wed", "Thurs", "Fri", "Sat"))
 
 #Month day
 tbl(db, "latix") %>%
   filter(!is.na(Issue_Day)) %>% 
   group_by(Issue_Day) %>% 
   tally() %>% 
   collect() %>% 
   ggplot() +
   geom_col(aes(x = Issue_Day, y = n)) 

# day <- tbl(db, "latix") %>% 
#   group_by(Issue_Wday) %>% 
#   tally() %>% 
#   collect() %>% 
#   filter(n == max(n))
# day






```


0. Which car makes received most citations?
```{r}

car <- tbl(db, "latix") %>% 
  group_by(Make) %>% 
  tally() %>% 
  collect()

top_n(car,10)


%>% 
  top_n(, 10)

car
  ggplot() +
  geom_col(aes(x = Make, y = n)) + 
  scale_x_continuous()

car
  
 
  
  tbl(db, "latix") %>%
   filter(!is.na(Issue_Day)) %>% 
   group_by(Issue_Day) %>% 
   tally() %>% 
   collect() %>%
  
   ggplot() +
   geom_col(aes(x = Issue_Day, y = n)) 
  
  top_n

  filter(n == max(n))
car

# 
# model <- latix$Make
# 
# table(model)
# max(table(model))


```

  *TOYT has the most citations. TOYT cars have 669,548 citations*
  
  
0. How many different colors of cars were ticketed? Which color attracted most tickets?
```{r}

library("dplyr")

diff_col <- tbl(db, "latix") %>% 
  group_by(Color) %>% 
  tally() %>% 
  collect()
diff_col

color <- tbl(db, "latix") %>% 
  group_by(Color) %>% 
  tally() %>% 
  collect() %>% 
  filter(n == max(n))
color


# 
# color <- latix$Color
# table(color)
# max(table(color))

```
*There are 66 different colors. BK is the color that was most ticketed*

0. What are the most common ticket types?

```{r}

ticket <- tbl(db, "latix") %>% 
  group_by(Violation_Description) %>% 
  tally() %>% 
  collect() %>% 
  filter(n == max(n))

ticket

```
  *No park/street clean is the most common ticket type*

0. How much money was collected on parking tickets in 2015 and 2016?
```{r}
# Fine_amount
# 
# data %>% 
#   group_by(subj) %>% 
#   summarise(n_child = n(),nOlder = sum(older),nYounger = sum(younger))


money <- tbl(db, "latix") %>% 
  filter(Issue_Year >= 2015, Issue_Year <= 2016) %>% 
  summarize(Fines = sum(Fine_amount, na.rm = TRUE))

money

# 
#   tally() %>% 
#   collect()
# 
#   group_by()
# 
# 
# diff_col <- tbl(db, "latix") %>% 
#   group_by(Color) %>% 
#   tally() %>% 
#   collect()
# diff_col
# 
# addr <- nyc_sql %>%
#   select(Issue_Date, Issuing_Agency, Violation_Precinct, Number, Street) %>%
#   filter(Violation_Precinct >= 1, Violation_Precinct <= 34)
# addr

```
0. Visualize any other information you are interested in.
```{r}


```